<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inventory</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/dashboardstyles.css') }}" />
  </head>
  <body>
    <nav>
      <h2 class="navtitle">KitchenSync</h2>
      <div>
        <ul>
          <li><a class="navoptions" href="{{url_for('home')}}">Home</a></li>
          <li><a class="navoptions" href="{{url_for('predictthedish')}}">Predict Dish</a></li>
          <li><a class="navoptions" href="{{url_for('logout')}}">Logout</a></li>
        </ul>
      </div>
    </nav>
    <div class="container">
      <br/>
      <h1>Manage Your Inventory</h1>
      <br />
      <form id="inventoryForm" action="/add_task" method="POST">
        <input type="text" name="item_name" placeholder="Item Name" required />
        <input
          type="date"
          name="expiry_date"
          placeholder="Expiry Date"
          required />
        <button type="submit">Add Item</button>
      </form>
      <!-- <br />
      <br /> -->
      <h2>Your Inventory List :</h2>
      <br />
      <div class="container2"style="overflow-x:auto;">
        <table id="inventoryTable">
          <thead>
            <tr>
              <th class="tablehead">Item Name</th>
              <th class="tablehead">Expiry Date</th>
              <th class="tablehead"></th>
            </tr>
          </thead>
          <tbody>
            {% for item in items %}
            <tr>
              <td>{{ item.item_name }}</td>
              <td>{{ item.expiry_date }}</td>
              <td>
                <button class="deletebtn" onclick="deleteItem('{{ item.id }}')">
                  Delete
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      </div>
      <!-- <br/>
      <br/> -->
      <!-- Display top 3 items that are going to expire soon -->
      <div id="recipe-container">
      <!-- <div class="container3"></div> -->
      <h2 class="invlist">Items Expiring Soon:</h2>
      <!-- <br/> -->
      {% for item in expiring_items %}
      <p>{{ item }} is expiring soon</p>
      {% endfor %}
      <!-- <br /><br /> -->
      <h2 class="invlist">Recipes with Expiring Items:</h2>
      <br/>
      <button id="how-to-use-button">How do I use them?</button>
      <br/>
      <br/>
      </div>

      <footer class="footer">
        <h4 class="footertext">Thank you for visiting us !</h4>
      </footer>

    <script>
      // Function to handle form submission for adding items
      document.getElementById("inventoryForm").addEventListener("submit", function (event) {
        event.preventDefault(); // Prevent the default form submission
        var formData = new FormData(this);
        fetch("/add_task", {
          method: "POST",
          body: formData,
        })
        .then((response) => response.json())
        .then((data) => {
          if (data.message === "Item added successfully") {
            alert("Item added successfully");
            location.reload(); // Reload the page to reflect the changes
          } else {
            alert("Error adding item");
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("Error adding item");
        });
      });
    
      // Function to handle item deletion
      function deleteItem(itemId) {
        if (confirm("Are you sure you want to delete this item?")) {
          fetch("/delete_item", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ item_id: itemId }),
          })
          .then((response) => response.json())
          .then((data) => {
            if (data.message === "Item deleted successfully") {
              location.reload();
            } else {
              alert("Error deleting item");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error deleting item" + error.message);
          });
        }
      }
    
      // Function to fetch and display recipes
      function getRecipes() {
  fetch("/get_recipes")
  .then((response) => response.json())
  .then((data) => {
    let recipesContainer = document.getElementById("recipe-container");
    recipesContainer.innerHTML = "";
    data.forEach((recipe) => {
      let recipeElement = document.createElement("div");
      recipeElement.innerHTML = `
        <h3>${recipe.title}</h3>
        <br/>
        <p><strong>Ingredients:</strong> ${Array.isArray(recipe.ingredients) ? recipe.ingredients.join(', ') : recipe.ingredients}</p>
        <br/>
        <p><strong>Instructions:</strong> ${recipe.instructions}</p>
        <br/>
        <br/>
        <br/>
        <br/>
      `;
      recipesContainer.appendChild(recipeElement);
    });
    recipesContainer.style.display = data.length > 0 ? "block" : "none";
  })
  .catch((error) => {
    console.error("Error fetching recipes:", error);
  });
}

document.getElementById("how-to-use-button").addEventListener("click", getRecipes);

    
function displayExpiringItemsAlert() {
        // Fetch the top 3 expiring items
        let expiringItems = JSON.parse('{{ expiring_items | tojson | safe }}');

        // Prepare alert message
        let alertMessage = "";
        if (expiringItems.length > 0) {
            if (expiringItems.length === 1) {
                alertMessage = `${expiringItems[0]} is/are expiring within 3 days!`;
            } else {
                alertMessage = `${expiringItems.slice(0, 3).join(', ')} are expiring soon!`;
            }

            // Display the alert message
            alert(alertMessage);
        }
    }

    // Call the function to display expiring items alert when the page loads
    window.onload = displayExpiringItemsAlert;

    
    </script>
    
  </body>
</html>
